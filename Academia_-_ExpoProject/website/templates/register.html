<!DOCTYPE html>
<html lang="mt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Applikazzjoni</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
</head>
<body class="bg-light">

  <!-- Language Switcher -->
  <div class="container text-end mt-2">
    <div class="d-inline-flex align-items-center" style="gap: 5px;">
      <a href="/register" style="background: transparent;">
        <img src="{{ url_for('static', filename='images/MT_Flag.png') }}" alt="Malti"
             style="height: 24px; width: 24px; opacity: {{ '1' if request.path == '/register' else '0.3' }};">
      </a>
      <a href="/register_en" style="background: transparent;">
        <img src="{{ url_for('static', filename='images/UK_Flag.png') }}" alt="English"
             style="height: 24px; width: 24px;">
      </a>
    </div>
  </div>

  <div class="container my-5">
    <div class="text-center mb-4">
      <h4 class="text-muted">Jirnexxielek Tohrog?</h4>
      <h2 class="fw-bold">Reġistrazzjoni</h2>
    </div>

    <form id="registrationForm" method="POST" action="/register" class="p-4 bg-white rounded shadow-lg">
      <h5 class="mb-3 text-start text-primary">👤 Dettalji tal-Leader tat-Tim</h5>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Karta tal-Identità</label>
          <input id="id1" type="text" class="form-control" name="id1" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Laqam / Isem tat-Tim</label>
          <input id="tName" type="text" class="form-control" name="tName" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Isem</label>
          <input id="name1" type="text" class="form-control" name="name1" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Kunjom</label>
          <input id="surname1" type="text" class="form-control" name="surname1" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input id="email1" type="email" class="form-control" name="email1" required />
        </div>
        <div class="col-md-6">
          <label class="form-label">Numru tal-Mowbajl</label>
          <input id="phone1" type="tel" class="form-control" name="phone1" required />
        </div>
      </div>

      <hr class="my-4" />

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tip ta' Grupp</label><br />
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="group_type" value="single" checked onchange="toggleDiv()" />
            <label class="form-check-label">Parteċipant Wieħed</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="group_type" value="group" onchange="toggleDiv()" />
            <label class="form-check-label">Grupp (massimu ta' 4)</label>
          </div>
        </div>

        <div id="valGroup" class="col-md-6" style="display: none">
          <label class="form-label">Numru ta' Parteċipanti</label>
          <input id="playersNum" type="number" class="form-control" name="players" min="2" max="4" value="2" required />
        </div>
      </div>

      <hr class="my-4" />

      <div id="additionPlayers" style="display: none">
        <h5 class="mb-3 text-start text-primary">👥 Parteċipanti Żejda</h5>
        <div id="playersContainer"></div>
        <hr class="my-4" />
      </div>

      <div class="text-center mb-3">
        <div class="form-check d-inline-block">
          <input type="checkbox" id="agree" name="agree" class="form-check-input" />
          <label class="form-check-label text-muted" for="agree">
            Jien naqbel ma’
            <a class="terms-link" href="#" data-bs-toggle="modal" data-bs-target="#termsModal">
              termini u kundizzjonijiet
            </a>
            ġaladarba nipparteċipa.
          </label>
        </div>
      </div>

      <button type="submit" class="btn btn-dark w-100">Ibgħat</button>
    </form>
  </div>

  <!-- Terms Modal -->
  <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="termsModalLabel">Termini u Kundizzjonijiet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Agħlaq"></button>
        </div>
        <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
          <p>Termini applikabbli għall-parteċipazzjoni tiegħek se jkunu murija hawn.</p>
          <p>Jekk jogħġbok aqrahom sew qabel tibda l-logħba.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Agħlaq</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleDiv() {
      const selectedValue = document.querySelector('input[name="group_type"]:checked').value;
      const valGroup = document.getElementById("valGroup");
      if (selectedValue === "group") {
        valGroup.style.display = "block";
        additionPlayers.style.display = "block";
        generatePlayerFields();
        const inputEl = document.getElementById("playersNum");
        if (inputEl && !inputEl.dataset.listenerAttached) {
          inputEl.addEventListener("input", generatePlayerFields);
          inputEl.dataset.listenerAttached = "true";
        }
      } else {
        valGroup.style.display = "none";
        additionPlayers.style.display = "none";
      }
    }

    function generatePlayerFields() {
      let number = parseInt(document.getElementById("playersNum").value);
      const container = document.getElementById("playersContainer");
      container.innerHTML = "";

      if (isNaN(number) || number < 2 || number > 4) {
        alert("Numru bejn 2 u 4 huwa meħtieġ jekk jintgħażel Grupp.");
        return;
      }
      number -= 1;

      for (let i = 1; i <= number; i++) {
        let playNum = i + 1;
        container.innerHTML += `
          <div class="row g-3 mb-2">
            <div class="col-md-3">
              <input class="form-control" id="id${playNum}" name="id${playNum}" placeholder="ID Parteċipant ${playNum}" required />
            </div>
            <div class="col-md-3">
              <input class="form-control" id="name${playNum}" name="name${playNum}" placeholder="Isem" required />
            </div>
            <div class="col-md-3">
              <input class="form-control" id="surname${playNum}" name="surname${playNum}" placeholder="Kunjom" required />
            </div>
            <div class="col-md-3">
              <input class="form-control" id="email${playNum}" name="email${playNum}" placeholder="Email" required />
            </div>
            <div class="col-md-3">
              <input class="form-control" id="phone${playNum}" name="phone${playNum}" placeholder="Mowbajl" required />
            </div>
          </div>`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("playersNum").addEventListener("input", generatePlayerFields);
      toggleDiv();

      document.getElementById('registrationForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        const existingAlert = document.getElementById('formAlert');
        if (existingAlert) existingAlert.remove(); // remove any previous alert

        const alertDiv = document.createElement('div');
        alertDiv.id = 'formAlert';
        alertDiv.className = `alert ${result.success ? 'alert-success' : 'alert-danger'} mt-3`;
        alertDiv.innerText = result.message;

        form.appendChild(alertDiv);

        if (result.success) {
          setTimeout(() => {
            window.location.href = "/"; // redirect after short delay
          }, 1500);
        }

      } catch (error) {
        console.error("Unexpected error:", error);
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.innerText = "❌ Żball mhux mistennija. Jekk jogħġbok erġa’ ipprova.";
        form.appendChild(alertDiv);
      }
    });
  });
  </script>
</body>
</html>
